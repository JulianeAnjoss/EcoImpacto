<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relatar Problema - EcoImpacto</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-gray-800 font-sans min-h-screen flex flex-col">

  <main class="flex-grow">
    <section id="relato" class="py-16 bg-white">
      <div class="max-w-3xl mx-auto px-6">
        <h1 class="text-4xl font-extrabold text-green-700 mb-8 text-center">
          üìù Relato Ambiental
        </h1>
        <p class="text-gray-700 text-center mb-12 max-w-xl mx-auto">
          Ajude a comunidade reportando problemas ambientais que voc√™ percebe no seu bairro.
        </p>

        <form id="formRelato" class="space-y-6 bg-green-50 p-8 rounded-xl shadow-lg border border-green-200">
          <!-- Tipo de problema -->
          <div>
            <label for="tipo" class="block text-sm font-semibold text-green-800 mb-2">Tipo de problema <span class="text-red-500">*</span></label>
            <select id="tipo" name="tipo" required class="w-full border border-green-300 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-green-400 transition">
              <option value="" disabled selected>Selecione...</option>
              <option value="acumulo_lixo">Ac√∫mulo de lixo</option>
              <option value="queimada">Queimada</option>
              <option value="escoamento">Problemas com escoamento</option>
              <option value="poluicao">Polui√ß√£o do ar ou sonora</option>
              <option value="inseguranca_alimentar">Inseguran√ßa alimentar</option>
              <option value="agricultura">Agricultura</option>
              <option value="preservacao_alimentar">Preserva√ß√£o alimentar</option>
              <option value="outro">Outro</option>
            </select>
          </div>

          <!-- Bairro -->
          <div>
            <label for="bairro" class="block text-sm font-semibold text-green-800 mb-2">Bairro <span class="text-red-500">*</span></label>
            <input type="text" id="bairro" name="bairro" placeholder="Ex: Jardim Am√©rica" required
              class="w-full border border-green-300 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-green-400 transition" />
          </div>

          <!-- Cidade -->
          <div>
            <label for="cidade" class="block text-sm font-semibold text-green-800 mb-2">Cidade <span class="text-red-500">*</span></label>
            <input type="text" id="cidade" name="cidade" placeholder="Ex: S√£o Paulo" required
              class="w-full border border-green-300 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-green-400 transition" />
          </div>

          <!-- Descri√ß√£o -->
          <div>
            <label for="descricao" class="block text-sm font-semibold text-green-800 mb-2">Descri√ß√£o do problema <span class="text-red-500">*</span></label>
            <textarea id="descricao" name="descricao" rows="5" placeholder="Descreva o problema, impacto e h√° quanto tempo ocorre..."
              required
              class="w-full border border-green-300 rounded-md p-3 resize-none focus:outline-none focus:ring-2 focus:ring-green-400 transition"></textarea>
          </div>

          <!-- Foto -->

<div>
  <label class="block text-sm font-semibold text-green-800 mb-2">Foto do local (opcional)</label>
  
  <!-- Input para escolher arquivo -->
  <input type="file" id="fotoInput" accept="image/*" class="w-full text-green-700 mb-2" />

  <!-- Bot√£o para abrir c√¢mera -->
  <button type="button" id="btnTirarFoto" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition mb-2">
    üì∑ Tirar foto
  </button>

  <!-- V√≠deo preview da c√¢mera -->
  <video id="videoCamera" autoplay playsinline class="rounded-md border border-green-300 w-full max-h-60 mb-2 hidden"></video>

  <!-- Bot√£o para capturar foto -->
  <button type="button" id="btnCapturar" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition mb-2 hidden">
    üì∏ Capturar Foto
  </button>

  <!-- Preview da foto capturada -->
  <canvas id="canvasFoto" class="rounded-md border border-green-300 w-full max-h-60 mb-2 hidden"></canvas>
</div>

          <!-- Bot√£o -->
          <div class="text-center">
            <button type="submit"
              class="bg-green-600 text-white px-8 py-3 rounded-full font-semibold hover:bg-green-700 transition shadow-md">
              Enviar Relato
            </button>
          </div>
        </form>

        <!-- Mensagem de confirma√ß√£o/erro -->
        <div id="mensagem" class="mt-6 text-center text-lg font-semibold hidden"></div>
      </div>
    </section>
  </main>

  <script>
    const form = document.getElementById("formRelato");
    const mensagem = document.getElementById("mensagem");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      mensagem.classList.add("hidden");
      mensagem.textContent = "";

      // Capturar valores
      const tipo = form.tipo.value;
      const bairro = form.bairro.value.trim();
      const cidade = form.cidade.value.trim();
      const descricao = form.descricao.value.trim();
      const dataAtual = new Date().toISOString().split('T')[0];

      if (!tipo || !bairro || !cidade || !descricao) {
        mensagem.textContent = "‚ùå Por favor, preencha todos os campos obrigat√≥rios.";
        mensagem.className = "mt-6 text-center text-red-600 font-semibold";
        mensagem.classList.remove("hidden");
        return;
      }

      // Dados para enviar
      const dados = { tipo, bairro, cidade, descricao, data: dataAtual };

      try {
        const resposta = await fetch("http://127.0.0.1:5000/relatos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dados),
        });

        if (resposta.ok) {
          mensagem.textContent = "‚úÖ Relato enviado com sucesso!";
          mensagem.className = "mt-6 text-center text-green-700 font-semibold";
          mensagem.classList.remove("hidden");
          form.reset();
        } else {
          mensagem.textContent = "‚ùå Erro ao enviar o relato. Tente novamente.";
          mensagem.className = "mt-6 text-center text-red-600 font-semibold";
          mensagem.classList.remove("hidden");
        }
      } catch (err) {
        console.error("Erro:", err);
        mensagem.textContent = "‚ùå Erro de conex√£o com o servidor.";
        mensagem.className = "mt-6 text-center text-red-600 font-semibold";
        mensagem.classList.remove("hidden");
      }
    });
  </script>

<script>
  // c√≥digo JavaScript que controla a c√¢mera, captura e preview da foto
  const btnTirarFoto = document.getElementById("btnTirarFoto");
  const videoCamera = document.getElementById("videoCamera");
  const btnCapturar = document.getElementById("btnCapturar");
  const canvasFoto = document.getElementById("canvasFoto");
  const fotoInput = document.getElementById("fotoInput");

  let stream = null;

  btnTirarFoto.addEventListener("click", async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      videoCamera.srcObject = stream;
      videoCamera.classList.remove("hidden");
      btnCapturar.classList.remove("hidden");
      btnTirarFoto.disabled = true;
      fotoInput.value = ""; // limpa sele√ß√£o de arquivo para evitar conflito
      canvasFoto.classList.add("hidden");
    } catch (err) {
      alert("N√£o foi poss√≠vel acessar a c√¢mera: " + err.message);
    }
  });

  btnCapturar.addEventListener("click", () => {
    const contexto = canvasFoto.getContext("2d");
    canvasFoto.width = videoCamera.videoWidth;
    canvasFoto.height = videoCamera.videoHeight;
    contexto.drawImage(videoCamera, 0, 0, canvasFoto.width, canvasFoto.height);

    // Para a c√¢mera
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }

    videoCamera.classList.add("hidden");
    btnCapturar.classList.add("hidden");
    btnTirarFoto.disabled = false;
    canvasFoto.classList.remove("hidden");
  });
</script>

</body>
</html>